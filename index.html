<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Dairy Ticketing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    :root {
      --main-bg: #f8faff; --primary: #001F3F; --accent: #FF851B;
      --danger: #FF4136; --success: #2ECC40; --font-main: 'Segoe UI', Arial, sans-serif;
      --logo-width: 210px; --max-width: 980px; --heading-size: 2rem;
    }
    body { background: var(--main-bg); color: var(--primary); font-family: var(--font-main);}
    .container-main { background: #fff; border-radius: 18px; max-width: var(--max-width); margin: 32px auto 0 auto; padding: 32px 20px 34px 20px; box-shadow: 0 2px 32px #001F3F11;}
    .logo-header { max-width: var(--logo-width); display:block; margin:0 auto 18px auto;}
    h1 { color: var(--accent); font-size: var(--heading-size); text-align:center;}
    .form-label { color: var(--primary); font-size: 1.08rem; font-weight:500;}
    .form-control, .form-select { border-radius: 8px;}
    .btn-agora { background: var(--accent); color:#fff; border:none; border-radius:5px; font-weight:500;}
    .btn-agora:hover { background: var(--danger);}
    .btn-admin { background: var(--primary); color:#fff; border:none; border-radius:5px;}
    .btn-admin:hover { background: #193a5e;}
    .btn-outline { background: #fff; color: var(--primary); border:1px solid var(--accent);}
    .btn-outline:hover { background: var(--accent); color:#fff;}
    .nav-btns { display:flex; gap:10px; justify-content:center; margin:16px 0 6px 0;}
    .ticket-link { cursor:pointer; text-decoration:underline; color:var(--primary);}
    .ticket-link:hover { color: var(--accent);}
    .ticket-status-open { color: var(--success); font-weight:600;}
    .ticket-status-closed { color: var(--danger);}
    .search-box { max-width: 210px; margin: 0 0 10px 0;}
    .logout-link { float:right; color:#a00; text-decoration:underline; cursor:pointer; font-size:0.97em;}
    .comment-box { background: #f6f6f8; border-radius: 7px; margin-bottom: 12px; padding: 10px;}
    .comment-meta { font-size:0.97em; color:#555;}
    .history-box { background: #fcfcfc; border-left: 3px solid var(--accent); margin-bottom: 14px; padding: 7px 12px;}
    .photo-thumb { max-width:80px; max-height:80px; display:inline-block; margin-right:5px;}
    .mt-2x { margin-top:2.2rem;}
    .csv-btn { float:right; font-size:0.9em; }
    @media (max-width:600px) { .container-main {padding:9px 2vw;} h1{font-size:1.3rem;}.logo-header{max-width:120px;}}
  </style>
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
<div class="container-main" id="main-box">
  <img id="logo-img" class="logo-header" style="display:none;">
  <h1>Agora Dairy Ticketing</h1>
  <!-- LOGIN/SIGNUP SECTION -->
  <div id="login-section">
    <div id="login-box" class="mb-3">
      <label class="form-label">Username</label>
      <input type="text" id="login-user" class="form-control" autocomplete="username" required>
      <label class="form-label mt-2">Password</label>
      <input type="password" id="login-pass" class="form-control" autocomplete="current-password" required>
      <button class="btn btn-agora mt-3 w-100" onclick="doLogin()">Login</button>
      <div class="mt-2 text-center">
        <span style="font-size:0.98em;">No account? <a href="#" onclick="showSignup()">Sign Up</a></span>
      </div>
    </div>
    <div id="signup-box" class="mb-3" style="display:none;">
      <label class="form-label">Full Name</label>
      <input type="text" id="signup-name" class="form-control" required>
      <label class="form-label mt-2">Username</label>
      <input type="text" id="signup-user" class="form-control" required>
      <label class="form-label mt-2">Password</label>
      <input type="password" id="signup-pass" class="form-control" required>
      <button class="btn btn-agora mt-3 w-100" onclick="doSignup()">Sign Up</button>
      <div class="mt-2 text-center">
        <span style="font-size:0.98em;">Have an account? <a href="#" onclick="showLogin()">Login</a></span>
      </div>
    </div>
    <div id="login-msg" class="text-danger mt-2" style="min-height:20px;"></div>
  </div>
  <!-- MAIN TICKET PAGE -->
  <div id="ticket-section" style="display:none;">
    <span class="logout-link" onclick="logout()">Logout</span>
    <div class="mb-2 text-center"><b id="user-position"></b></div>
    <form id="ticket-form" autocomplete="off" enctype="multipart/form-data">
      <div class="mb-2">
        <label class="form-label">Service Person</label>
        <input type="text" id="service-person" class="form-control" readonly>
      </div>
      <div class="mb-2">
        <label class="form-label">Date</label>
        <input type="date" id="ticket-date" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Dairy Number</label>
        <input type="text" id="dairy-number" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Farm Name</label>
        <input type="text" id="farm-name" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Alert Type</label>
        <select id="alert-type" class="form-select" onchange="toggleOtherAlert()">
          <option value="">Select...</option>
          <option value="Temperature">Temperature</option>
          <option value="Concentration">Concentration</option>
          <option value="Plant Pressure">Plant Pressure</option>
          <option value="Milking Vacuum">Milking Vacuum</option>
          <option value="Teat Spray">Teat Spray</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-2" id="other-alert-div" style="display:none;">
        <label class="form-label">Other Alert Type</label>
        <input type="text" id="alert-other" class="form-control">
      </div>
      <div class="mb-2">
        <label class="form-label">Priority</label>
        <select id="priority" class="form-select">
          <option value="Low">Low</option>
          <option value="Medium" selected>Medium</option>
          <option value="High">High</option>
          <option value="Urgent">Urgent</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Assign To</label>
        <select id="assign-to" class="form-select"></select>
      </div>
      <div class="mb-2">
        <label class="form-label">Description of Issue</label>
        <textarea id="issue-desc" class="form-control" rows="2" required></textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Attach Photo/File</label>
        <input type="file" id="ticket-file" class="form-control" accept="image/*,.pdf,.doc,.docx,.txt" multiple>
        <div id="ticket-file-preview"></div>
      </div>
      <button type="button" class="btn btn-agora mt-2" onclick="submitTicket()">Create Ticket</button>
    </form>
    <div class="nav-btns mt-2x">
      <button class="btn btn-outline" onclick="showOpenTickets()">Open Tickets <span id="num-open-tix" class="badge bg-success"></span></button>
      <button class="btn btn-outline" id="btn-closed-tickets" onclick="showClosedTickets()" style="display:none;">Closed Tickets</button>
      <button class="btn btn-admin" id="btn-summary" onclick="showSummary()" style="display:none;">Summary</button>
      <button class="btn btn-admin ms-3" id="btn-admin" onclick="adminPanel()" style="display:none;">Admin Panel</button>
    </div>
    <div id="ticket-msg" class="mt-2" style="min-height:22px;"></div>
  </div>
  <!-- TICKET VIEWS -->
  <div id="ticket-list-section" style="display:none;">
    <div class="mb-2">
      <button class="btn btn-outline" onclick="backToMain()">Back</button>
      <button class="btn btn-admin csv-btn" id="btn-csv" style="display:none;" onclick="exportToCSV()">Export All to CSV</button>
    </div>
    <div id="ticket-list-controls" class="mb-3"></div>
    <div id="ticket-list-table"></div>
    <div id="ticket-view-modal" style="display:none;" class="mt-3"></div>
  </div>
</div>

<!-- Firebase for Storage Only -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
<script>
// ---- GLOBAL SETTINGS ----
const EMAILJS_SERVICE_ID = "service_228tpco";
const EMAILJS_TEMPLATE_ID = "template_9s0ckye";
const EMAILJS_PUBLIC_KEY = "8uQgECrkNStKV41S-";
const TICKET_URL_ROOT = "https://agoranz.github.io/Ticket/";

// ---- USERS (Demo for local login, use localStorage only for testing) ----
const initialUsers = [
  { username: "regan.beaver@agora.co.nz", name: "Regan Beaver", password: "Moometrics24", role: "admin" },
  { username: "ahren.lomas@agora.co.nz", name: "Ahren lomas", password: "Moometrics24", role: "admin" },
  { username: "caroline@agora.co.nz", name: "Caroline Wallace", password: "dairy123", role: "admin" },
  { username: "admin", name: "test", password: "test123", role: "admin" }
];
if(!localStorage.getItem("users")) {
  const saveUsers = initialUsers.map(u => ({...u, username: u.username.toLowerCase()}));
  localStorage.setItem("users", JSON.stringify(saveUsers));
}

// ---- FIREBASE ----
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const ticketsFolder = "Agora V1 Tickets";

// ---- EMAILJS ----
emailjs.init(EMAILJS_PUBLIC_KEY);

// ---- LOGO LOAD ----
(async function(){
  try {
    const logoRef = storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
    const logoUrl = await logoRef.getDownloadURL();
    document.getElementById("logo-img").src = logoUrl;
    document.getElementById("logo-img").style.display = "block";
  } catch {}
})();

// ---- DEMO AUTH ----
let curUser = null;
function showLogin() {
  document.getElementById('login-box').style.display = '';
  document.getElementById('signup-box').style.display = 'none';
  document.getElementById('login-msg').textContent = '';
}
function showSignup() {
  document.getElementById('login-box').style.display = 'none';
  document.getElementById('signup-box').style.display = '';
  document.getElementById('login-msg').textContent = '';
}
function showMain() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('ticket-section').style.display = '';
  document.getElementById('ticket-list-section').style.display = 'none';
  updateNavButtons();
  autoFillTicketForm();
  loadOpenTicketCount();
}
function logout() { curUser = null; location.hash = ""; location.reload(); }
function getUsers() { return JSON.parse(localStorage.getItem("users")||"[]"); }
function setUsers(users) { localStorage.setItem("users", JSON.stringify(users)); }
function findUser(username) { return getUsers().find(u => u.username === username.trim().toLowerCase()); }
function doLogin() {
  let username = document.getElementById('login-user').value.trim().toLowerCase();
  let password = document.getElementById('login-pass').value;
  let user = findUser(username);
  if(user && user.password === password) {
    curUser = user;
    showMain();
    // Check if direct ticket in hash
    checkHashForTicket();
  } else {
    document.getElementById('login-msg').textContent = "Login failed: Wrong username or password.";
  }
}
function doSignup() {
  let name = document.getElementById('signup-name').value.trim();
  let username = document.getElementById('signup-user').value.trim().toLowerCase();
  let password = document.getElementById('signup-pass').value;
  if(!name||!username||!password) return document.getElementById('login-msg').textContent="All fields required.";
  if(findUser(username)) return document.getElementById('login-msg').textContent="Username already exists.";
  let users = getUsers();
  let user = {username, name, password, role:"service"};
  users.push(user); setUsers(users);
  curUser = user;
  showMain();
}
function updateNavButtons() {
  document.getElementById('user-position').textContent = `Position: Agora Service | ${curUser.name} (${curUser.role})`;
  document.getElementById('btn-closed-tickets').style.display = curUser.role==="admin" ? "" : "none";
  document.getElementById('btn-summary').style.display = curUser.role==="admin" ? "" : "none";
  document.getElementById('btn-admin').style.display = curUser.role==="admin" ? "" : "none";
}

// ---- TICKET FORM LOGIC ----
function autoFillTicketForm() {
  document.getElementById('service-person').value = curUser.name;
  document.getElementById('ticket-date').value = (new Date()).toISOString().substr(0,10);
  // Populate assign-to dropdown
  let users = getUsers().filter(u=>u.role!=="admin"||curUser.role==="admin"); // allow admin to assign to anyone
  let assignSel = document.getElementById('assign-to');
  assignSel.innerHTML = '';
  users.forEach(u=>{
    assignSel.innerHTML += `<option value="${u.username}">${u.name}</option>`;
  });
  if(users.length && !assignSel.value) assignSel.value = users[0].username;
  document.getElementById('ticket-file').value = '';
  document.getElementById('ticket-file-preview').innerHTML = '';
}
function toggleOtherAlert() {
  let v = document.getElementById('alert-type').value;
  document.getElementById('other-alert-div').style.display = v==="Other"?"":"none";
}
document.getElementById('ticket-file').addEventListener('change', function(){
  let files = Array.from(this.files);
  let div = document.getElementById('ticket-file-preview');
  div.innerHTML = '';
  files.forEach(f=>{
    if(f.type.startsWith('image/')){
      let img = document.createElement('img');
      img.className = 'photo-thumb';
      img.src = URL.createObjectURL(f);
      div.appendChild(img);
    } else {
      let p = document.createElement('span');
      p.textContent = f.name;
      div.appendChild(p);
    }
  });
});
async function submitTicket() {
  let data = {
    id: uuidv4(),
    createdDate: document.getElementById('ticket-date').value,
    dairyNumber: document.getElementById('dairy-number').value.trim(),
    farmName: document.getElementById('farm-name').value.trim(),
    alertType: document.getElementById('alert-type').value,
    alertOther: document.getElementById('alert-other').value.trim(),
    issueDesc: document.getElementById('issue-desc').value.trim(),
    priority: document.getElementById('priority').value,
    assignedTo: document.getElementById('assign-to').value,
    assignedName: getUsers().find(u=>u.username===document.getElementById('assign-to').value).name,
    status: "open",
    openedBy: curUser.name,
    openedByUser: curUser.username,
    position: "Agora Service",
    comments: [],
    history: [{ action: "Created", user: curUser.name, date: (new Date()).toISOString(), details: "" }],
    files: [],
    closedBy: "", closeComment: "", closedDate: null
  };
  if(!data.dairyNumber||!data.farmName||!data.alertType||!data.issueDesc)
    return (document.getElementById('ticket-msg').textContent="All required fields must be filled out.");
  if(data.alertType==="Other" && !data.alertOther)
    return (document.getElementById('ticket-msg').textContent="Specify the 'Other' alert type.");
  // Handle files
  let fileInput = document.getElementById('ticket-file');
  let files = Array.from(fileInput.files||[]);
  if(files.length){
    for(let f of files){
      let url = await uploadFileBlob(f, data.id);
      data.files.push({ name: f.name, type: f.type, url });
    }
  }
  await storage.ref(`${ticketsFolder}/${data.id}.json`).put(new Blob([JSON.stringify(data)],{type:"application/json"}));
  document.getElementById('ticket-msg').textContent = "Ticket created.";
  document.getElementById('ticket-form').reset();
  autoFillTicketForm();
  loadOpenTicketCount();
  // EMAIL NOTIFICATION
  sendTicketEmailNotification(data);
}
async function uploadFileBlob(file, ticketId) {
  let ref = storage.ref(`${ticketsFolder}/attachments/${ticketId}_${file.name}`);
  await ref.put(file);
  return await ref.getDownloadURL();
}
async function loadOpenTicketCount() {
  let tickets = await loadAllTickets();
  let n = tickets.filter(t=>t.status==="open").length;
  document.getElementById('num-open-tix').textContent = n;
}

// ---- EMAIL NOTIFICATION ----
function sendTicketEmailNotification(ticket) {
  // get users
  const users = getUsers();
  const assignUser = users.find(u=>u.username === ticket.assignedTo);
  const openedUser = users.find(u=>u.username === ticket.openedByUser);
  // To: assigned user; CC: opened by user if different
  let email_to = assignUser ? assignUser.username : "";
  let email_cc = (assignUser && openedUser && assignUser.username !== openedUser.username) ? openedUser.username : "";
  // Build ticket link
  let ticket_link = TICKET_URL_ROOT + "#ticket=" + ticket.id;
  // EmailJS send
  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
    name: ticket.openedBy,
    assigned: ticket.assignedName,
    priority: ticket.priority,
    email_to,
    email_cc,
    ticket_link,
    farm: ticket.farmName,
    dairy: ticket.dairyNumber,
    alert_type: ticket.alertType === "Other" ? (ticket.alertOther || "Other") : ticket.alertType,
    message: ticket.issueDesc,
    time: ticket.createdDate
  }).then(function(){
    document.getElementById('ticket-msg').textContent += " & notification sent.";
  },function(e){
    document.getElementById('ticket-msg').textContent += " & email failed.";
  });
}

// ---- DIRECT TICKET LINK SUPPORT ----
function checkHashForTicket() {
  // Only run after login
  if (location.hash.startsWith("#ticket=")) {
    let ticketId = location.hash.replace("#ticket=", "");
    showOpenTickets().then(() => {
      setTimeout(() => {
        window.viewTicketDetails(ticketId, false);
      }, 600);
    });
  }
}
// Also run after login (in doLogin), or manually after page load
window.onload = function() {
  // Optionally auto-login, else prompt login
  // But after login, run checkHashForTicket()
  // If you want: run checkHashForTicket();
};

// ---- TICKET LOAD/VIEW (as above, unchanged) ----
// ... [Rest of your ticket loading, admin panel, CSV export, comment add, etc logic goes here, exactly as in your code above] ...

// KEEP ALL YOUR PREVIOUS CODE AFTER THIS (all ticket views, admin, summary, etc) UNCHANGED.
// The only major changes required to make the above work are the email notification logic and the direct ticket loading on hash in URL.

</script>
</body>
</html>