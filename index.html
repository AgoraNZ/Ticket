<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Ticketing Advanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS (for base styles only) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    :root {
      --main-bg: #f8faff; --primary: #001F3F; --accent: #FF851B;
      --danger: #FF4136; --success: #2ECC40; --font-main: 'Segoe UI', Arial, sans-serif;
      --logo-width: 210px; --max-width: 980px; --heading-size: 2rem;
      --table-font: 0.95rem;
    }
    body { background: var(--main-bg); color: var(--primary); font-family: var(--font-main); }
    .container-main { background: #fff; border-radius: 18px; max-width: var(--max-width); margin: 32px auto 0 auto; padding: 32px 20px 34px 20px; box-shadow: 0 2px 32px #001F3F11; }
    .logo-header { max-width: var(--logo-width); display:block; margin:0 auto 18px auto; }
    h1 { color: var(--accent); font-size: var(--heading-size); text-align:center; }
    .form-label { color: var(--primary); font-size: 1.08rem; font-weight:500; }
    .form-control, .form-select { border-radius: 8px; }
    .btn-agora { background: var(--accent); color:#fff; border:none; border-radius:5px; font-weight:500; }
    .btn-agora:hover { background: var(--danger); }
    .btn-admin { background: var(--primary); color:#fff; border:none; border-radius:5px; }
    .btn-admin:hover { background: #193a5e; }
    .btn-outline { background: #fff; color: var(--primary); border:1px solid var(--accent); }
    .btn-outline:hover { background: var(--accent); color:#fff; }
    .nav-btns { display:flex; gap:10px; justify-content:center; margin:16px 0 6px 0; }
    .ticket-link { cursor:pointer; text-decoration:underline; color:var(--primary); }
    .ticket-link:hover { color: var(--accent); }
    .ticket-status-open { color: var(--success); font-weight:600; }
    .ticket-status-closed { color: var(--danger); }
    .search-box { max-width: 210px; margin: 0 0 10px 0; }
    .logout-link { float:right; color:#a00; text-decoration:underline; cursor:pointer; font-size:0.97em; }
    .comment-box { background: #f6f6f8; border-radius: 7px; margin-bottom: 12px; padding: 10px; }
    .comment-meta { font-size:0.97em; color:#555; }
    .history-box { background: #fcfcfc; border-left: 3px solid var(--accent); margin-bottom: 14px; padding: 7px 12px; }
    .photo-thumb { max-width:80px; max-height:80px; display:inline-block; margin:4px 6px 4px 0; border-radius: 6px; border: 1px solid #eee; }
    .mt-2x { margin-top:2.2rem; }
    .csv-btn { float:right; font-size:0.9em; }
    .table, .table * { font-size: var(--table-font) !important; } /* normalize table font size */
    .chip { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:14px; margin-right:6px; cursor:pointer; user-select:none; }
    .chip.active { border-color: var(--accent); color: var(--accent); font-weight:600; }
    .file-chip { display:inline-block; padding:3px 6px; border:1px solid #eee; border-radius:6px; margin:3px 6px 3px 0; font-size:0.9em; }
    .progress-mini { height:6px; background:#eee; border-radius:8px; overflow:hidden; width:180px; display:inline-block; vertical-align:middle; margin-left:8px; }
    .progress-mini > div { height:100%; background: var(--accent); width:0%; transition: width 0.2s; }
    .small-note { font-size: 0.9em; color: #666; }
    /* Simple modal */
    .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal-card { width: min(600px, 94vw); background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
    .modal-header { font-weight:700; margin-bottom:8px; color: var(--primary); }
    .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    @media (max-width:600px) { .container-main { padding:9px 2vw; } h1{ font-size:1.3rem; } .logo-header{ max-width:120px; } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
<div class="container-main" id="main-box">
  <img id="logo-img" class="logo-header" style="display:none;">
  <h1>Agora Dairy Ticketing</h1>

  <!-- LOGIN/SIGNUP SECTION -->
  <div id="login-section">
    <div id="login-box" class="mb-3">
      <label class="form-label">Username</label>
      <input type="text" id="login-user" class="form-control" autocomplete="username" required>
      <label class="form-label mt-2">Password</label>
      <input type="password" id="login-pass" class="form-control" autocomplete="current-password" required>
      <button class="btn btn-agora mt-3 w-100" onclick="doLogin()">Login</button>
      <div class="mt-2 text-center">
        <span style="font-size:0.98em;">No account? <a href="#" onclick="showSignup()">Sign Up</a></span>
      </div>
    </div>

    <div id="signup-box" class="mb-3" style="display:none;">
      <label class="form-label">Full Name</label>
      <input type="text" id="signup-name" class="form-control" required>
      <label class="form-label mt-2">Username</label>
      <input type="text" id="signup-user" class="form-control" required>
      <label class="form-label mt-2">Password</label>
      <input type="password" id="signup-pass" class="form-control" required>
      <button class="btn btn-agora mt-3 w-100" onclick="doSignup()">Sign Up</button>
      <div class="mt-2 text-center">
        <span style="font-size:0.98em;">Have an account? <a href="#" onclick="showLogin()">Login</a></span>
      </div>
    </div>
    <div id="login-msg" class="text-danger mt-2" style="min-height:20px;"></div>
  </div>

  <!-- MAIN TICKET PAGE -->
  <div id="ticket-section" style="display:none;">
    <span class="logout-link" onclick="logout()">Logout</span>
    <div class="mb-2 text-center"><b id="user-position"></b></div>

    <form id="ticket-form" autocomplete="off" enctype="multipart/form-data">
      <div class="mb-2">
        <label class="form-label">Service Person</label>
        <input type="text" id="service-person" class="form-control" readonly>
      </div>

      <div class="mb-2">
        <label class="form-label">Date</label>
        <input type="date" id="ticket-date" class="form-control" required>
      </div>

      <div class="mb-2">
        <label class="form-label">Dairy Number</label>
        <input type="text" id="dairy-number" class="form-control" required>
      </div>

      <div class="mb-2">
        <label class="form-label">Farm Name</label>
        <input type="text" id="farm-name" class="form-control" required>
      </div>

      <div class="mb-2">
        <label class="form-label">Alert Type</label>
        <select id="alert-type" class="form-select" onchange="toggleOtherAlert()">
          <option value="">Select...</option>
          <option value="Temperature">Temperature</option>
          <option value="Concentration">Concentration</option>
          <option value="Plant Pressure">Plant Pressure</option>
          <option value="Milking Vacuum">Milking Vacuum</option>
          <option value="Teat Spray">Teat Spray</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="mb-2" id="other-alert-div" style="display:none;">
        <label class="form-label">Other Alert Type</label>
        <input type="text" id="alert-other" class="form-control">
      </div>

      <div class="mb-2">
        <label class="form-label">Priority</label>
        <select id="priority" class="form-select">
          <option value="Low">Low</option>
          <option value="Medium" selected>Medium</option>
          <option value="High">High</option>
          <option value="Urgent">Urgent</option>
        </select>
      </div>

      <div class="mb-2">
        <label class="form-label">Assign To (hold Ctrl/Cmd to select multiple)</label>
        <select id="assign-to" class="form-select" multiple></select>
        <div class="small-note mt-1">Admins can edit assignees later in the ticket view.</div>
      </div>

      <div class="mb-2">
        <label class="form-label">Description of Issue</label>
        <textarea id="issue-desc" class="form-control" rows="2" required></textarea>
      </div>

      <div class="mb-2">
        <label class="form-label">Attach Photo/File</label>
        <input type="file" id="ticket-file" class="form-control"
               accept="image/*,.pdf,.doc,.docx,.txt" multiple capture="environment">
        <div id="ticket-file-preview"></div>
      </div>

      <button type="button" class="btn btn-agora mt-2" onclick="submitTicket()">Create Ticket</button>
    </form>

    <div class="nav-btns mt-2x">
      <button class="btn btn-outline" onclick="showOpenTickets()">Open Tickets <span id="num-open-tix" class="badge bg-success"></span></button>
      <button class="btn btn-outline" id="btn-closed-tickets" onclick="showClosedTickets()" style="display:none;">Closed Tickets</button>
      <button class="btn btn-admin" id="btn-summary" onclick="showSummary()" style="display:none;">Summary</button>
      <button class="btn btn-admin ms-3" id="btn-admin" onclick="adminPanel()" style="display:none;">Admin Panel</button>
    </div>
    <div id="ticket-msg" class="mt-2" style="min-height:22px;"></div>
  </div>

  <!-- LIST / DETAILS -->
  <div id="ticket-list-section" style="display:none;">
    <div class="mb-2 d-flex justify-content-between align-items-center">
      <button class="btn btn-outline" onclick="backToMain()">Back</button>
      <button class="btn btn-admin csv-btn" id="btn-csv" style="display:none;" onclick="exportToCSV()">Export All to CSV</button>
    </div>
    <div id="ticket-list-controls" class="mb-3"></div>
    <div id="ticket-list-table"></div>
    <div id="ticket-view-modal" style="display:none;" class="mt-3"></div>
  </div>
</div>

<!-- Simple Close Modal -->
<div class="modal-mask" id="close-modal">
  <div class="modal-card">
    <div class="modal-header">Close Ticket</div>
    <div class="mb-2">
      <label class="form-label">Resolution / Action Taken</label>
      <textarea id="close-note" class="form-control" rows="3" placeholder="Describe the fix"></textarea>
    </div>
    <div class="mb-2">
      <label class="form-label">Attach Photo(s) / File(s)</label>
      <input type="file" id="close-files" class="form-control" multiple accept="image/*,.pdf,.doc,.docx,.txt" capture="environment">
      <div id="close-files-preview" class="mt-1"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="hideCloseModal()">Cancel</button>
      <button class="btn btn-agora" onclick="doCloseFromModal()">Close Ticket</button>
    </div>
  </div>
</div>

<!-- Firebase (Storage only) -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
<script>
/* =================== CONFIG / INIT =================== */
const initialUsers = [
  { username: "regan.beaver@agora.co.nz", name: "Regan Beaver", password: "Moometrics24", role: "admin" },
  { username: "ahren.lomas@agora.co.nz", name: "Ahren Lomas", password: "Moometrics24", role: "admin" },
  { username: "caroline@agora.co.nz", name: "Caroline Wallace", password: "dairy123", role: "admin" },
  { username: "kip@agora.co.nz", name: "Kip Bodle", password: "dairy123", role: "admin" },
  { username: "josh.bull@agora.co.nz", name: "Josh Bull", password: "dairy123", role: "admin" }
];
if(!localStorage.getItem("users")) {
  const saveUsers = initialUsers.map(u => ({...u, username: u.username.toLowerCase()}));
  localStorage.setItem("users", JSON.stringify(saveUsers));
}

const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const ticketsFolder = "Agora V1 Tickets";

// EmailJS config
const EMAILJS_SERVICE_ID = "service_228tpco";
const EMAILJS_TEMPLATE_ID = "template_9s0ckye";
const EMAILJS_PUBLIC_KEY = "8uQgECrkNStKV41S-";
const TICKET_URL_ROOT = "https://agoranz.github.io/Ticket/";

emailjs.init(EMAILJS_PUBLIC_KEY);

// State
let curUser = null;
let closeTicketId = null;

/* =================== AUTH =================== */
function showLogin() {
  document.getElementById('login-box').style.display = '';
  document.getElementById('signup-box').style.display = 'none';
  document.getElementById('login-msg').textContent = '';
}
function showSignup() {
  document.getElementById('login-box').style.display = 'none';
  document.getElementById('signup-box').style.display = '';
  document.getElementById('login-msg').textContent = '';
}
function showMain() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('ticket-section').style.display = '';
  document.getElementById('ticket-list-section').style.display = 'none';
  updateNavButtons();
  autoFillTicketForm();
  loadOpenTicketCount();
  checkHashForTicket();
}
function logout() { curUser = null; location.reload(); }
function getUsers() { return JSON.parse(localStorage.getItem("users")||"[]"); }
function setUsers(users) { localStorage.setItem("users", JSON.stringify(users)); }
function findUser(username) { return getUsers().find(u => u.username === username.trim().toLowerCase()); }
function doLogin() {
  let username = document.getElementById('login-user').value.trim().toLowerCase();
  let password = document.getElementById('login-pass').value;
  let user = findUser(username);
  if(user && user.password === password) {
    curUser = user; showMain();
  } else {
    document.getElementById('login-msg').textContent = "Login failed: Wrong username or password.";
  }
}
function doSignup() {
  let name = document.getElementById('signup-name').value.trim();
  let username = document.getElementById('signup-user').value.trim().toLowerCase();
  let password = document.getElementById('signup-pass').value;
  if(!name||!username||!password) return document.getElementById('login-msg').textContent="All fields required.";
  if(findUser(username)) return document.getElementById('login-msg').textContent="Username already exists.";
  let users = getUsers();
  let user = {username, name, password, role:"service"};
  users.push(user); setUsers(users);
  curUser = user; showMain();
}
function updateNavButtons() {
  document.getElementById('user-position').textContent = `Position: Agora Service | ${curUser.name} (${curUser.role})`;
  const isAdmin = curUser.role==="admin";
  document.getElementById('btn-closed-tickets').style.display = isAdmin ? "" : "none";
  document.getElementById('btn-summary').style.display = isAdmin ? "" : "none";
  document.getElementById('btn-admin').style.display = isAdmin ? "" : "none";
}

/* =================== FORM HELPERS =================== */
(async function(){
  try {
    const logoRef = storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
    const logoUrl = await logoRef.getDownloadURL();
    document.getElementById("logo-img").src = logoUrl;
    document.getElementById("logo-img").style.display = "block";
  } catch {}
})();
function autoFillTicketForm() {
  document.getElementById('service-person').value = curUser.name;
  document.getElementById('ticket-date').value = (new Date()).toISOString().substr(0,10);

  // Populate assign-to (multi)
  let users = getUsers();
  let assignSel = document.getElementById('assign-to');
  assignSel.innerHTML = '';
  users.forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.username.toLowerCase();
    opt.textContent = u.name;
    assignSel.appendChild(opt);
  });

  // reset files preview
  document.getElementById('ticket-file').value = '';
  document.getElementById('ticket-file-preview').innerHTML = '';
}
function toggleOtherAlert() {
  let v = document.getElementById('alert-type').value;
  document.getElementById('other-alert-div').style.display = v==="Other"?"":"none";
}
document.getElementById('ticket-file').addEventListener('change', function(){
  renderFilePreview(this.files, document.getElementById('ticket-file-preview'));
});
function renderFilePreview(fileList, container) {
  const files = Array.from(fileList||[]);
  container.innerHTML = '';
  files.forEach(f=>{
    if(f.type && f.type.startsWith('image/')){
      const img = document.createElement('img');
      img.className = 'photo-thumb';
      img.src = URL.createObjectURL(f);
      container.appendChild(img);
    } else {
      const span = document.createElement('span');
      span.className = 'file-chip';
      span.textContent = f.name;
      container.appendChild(span);
    }
  });
}

/* =================== STORAGE HELPERS =================== */
const MAX_FILE_MB = 20;
const ALLOWED_TYPES = [
  'image/jpeg','image/png','image/gif','image/webp','application/pdf',
  'application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','text/plain'
];
function validateFiles(files) {
  const errs = [];
  for (let f of files) {
    if (f.size > MAX_FILE_MB*1024*1024) errs.push(`${f.name}: > ${MAX_FILE_MB}MB`);
    if (!ALLOWED_TYPES.includes(f.type) && !f.type.startsWith('image/')) errs.push(`${f.name}: unsupported type`);
  }
  return errs;
}
async function uploadFileBlob(file, pathPrefix, progressEl) {
  const ref = storage.ref(`${ticketsFolder}/${pathPrefix}_${file.name}`);
  const task = ref.put(file);
  return new Promise((resolve,reject)=>{
    task.on('state_changed', snap=>{
      if(progressEl){
        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
        progressEl.style.width = pct + '%';
      }
    }, reject, async ()=>{
      const url = await ref.getDownloadURL();
      resolve(url);
    });
  });
}

/* =================== CREATE TICKET =================== */
async function submitTicket() {
  const assignedUsernames = Array.from(document.getElementById('assign-to').selectedOptions).map(o=>o.value.toLowerCase());
  if(assignedUsernames.length === 0) return (document.getElementById('ticket-msg').textContent="Select at least one assignee.");

  const users = getUsers();
  const assignedNames = assignedUsernames.map(u => (users.find(x=>x.username===u)||{}).name || u);

  const data = {
    id: uuidv4(),
    createdDate: document.getElementById('ticket-date').value,
    dairyNumber: document.getElementById('dairy-number').value.trim(),
    farmName: document.getElementById('farm-name').value.trim(),
    alertType: document.getElementById('alert-type').value,
    alertOther: document.getElementById('alert-other').value.trim(),
    issueDesc: document.getElementById('issue-desc').value.trim(),
    priority: document.getElementById('priority').value,
    assignedTo: assignedUsernames,             // ARRAY
    assignedNames: assignedNames,              // ARRAY
    status: "open",
    openedBy: curUser.name,
    openedByUser: curUser.username,
    position: "Agora Service",
    comments: [],
    history: [{ action: "Created", user: curUser.name, date: (new Date()).toISOString(), details: "" }],
    files: [],
    close: null                                // { note, by, date, files:[] }
  };

  // validate fields
  if(!data.dairyNumber||!data.farmName||!data.alertType||!data.issueDesc)
    return (document.getElementById('ticket-msg').textContent="All required fields must be filled out.");
  if(data.alertType==="Other" && !data.alertOther)
    return (document.getElementById('ticket-msg').textContent="Specify the 'Other' alert type.");

  // initial attachments
  const fileInput = document.getElementById('ticket-file');
  const files = Array.from(fileInput.files||[]);
  const errs = validateFiles(files);
  if (errs.length) return alert("Upload errors:\n" + errs.join("\n"));

  if(files.length){
    // quick inline progress
    const pv = document.getElementById('ticket-file-preview');
    files.forEach(()=> {
      const bar = document.createElement('div'); bar.className='progress-mini'; bar.innerHTML='<div></div>'; pv.appendChild(bar);
    });
    for(let i=0;i<files.length;i++){
      const f = files[i];
      const barFill = pv.querySelectorAll('.progress-mini > div')[i];
      const url = await uploadFileBlob(f, `attachments/${data.id}`, barFill);
      data.files.push({ name: f.name, type: f.type, url });
    }
  }

  await storage.ref(`${ticketsFolder}/${data.id}.json`).put(new Blob([JSON.stringify(data)],{type:"application/json"}));
  document.getElementById('ticket-msg').textContent = "Ticket created.";
  document.getElementById('ticket-form').reset();
  autoFillTicketForm();
  loadOpenTicketCount();

  // emails to all assignees
  for (const uname of assignedUsernames) {
    const toUser = users.find(u=>u.username===uname);
    if (toUser) sendTicketEmailNotification(data, toUser.username);
  }
}

/* =================== LOAD / COUNTS =================== */
async function loadOpenTicketCount() {
  let tickets = await loadAllTickets();
  let n = tickets.filter(t=>t.status==="open").length;
  document.getElementById('num-open-tix').textContent = n;
}
async function loadAllTickets() {
  try {
    let folderRef = storage.ref(ticketsFolder);
    let res = await folderRef.listAll();
    let arr = [];
    for(let fileRef of res.items) {
      if(fileRef.name.endsWith('.json') && !fileRef.name.startsWith('attachments/')){
        let url = await fileRef.getDownloadURL();
        let data = await fetch(url).then(r=>r.json());
        // Back-compat: upgrade schema in-memory
        if (!Array.isArray(data.assignedTo)) data.assignedTo = data.assignedTo ? [data.assignedTo] : [];
        if (!Array.isArray(data.assignedNames)) data.assignedNames = data.assignedName ? [data.assignedName] : (data.assignedTo||[]);
        if (!data.comments) data.comments = [];
        if (!data.history) data.history = [];
        arr.push(data);
      }
    }
    return arr;
  } catch { return []; }
}

/* =================== NAV =================== */
function backToMain() {
  showMain();
  document.getElementById('ticket-list-table').innerHTML = "";
  document.getElementById('ticket-list-controls').innerHTML = "";
  document.getElementById('ticket-view-modal').style.display = "none";
  document.getElementById('btn-csv').style.display = "none";
}
async function showOpenTickets() {
  document.getElementById('ticket-section').style.display="none";
  document.getElementById('ticket-list-section').style.display="";
  document.getElementById('btn-csv').style.display = curUser.role==="admin" ? "" : "none";
  ticketFilterUI('open');
}
async function showClosedTickets() {
  if(curUser.role!=="admin") return alert("Admins only.");
  document.getElementById('ticket-section').style.display="none";
  document.getElementById('ticket-list-section').style.display="";
  document.getElementById('btn-csv').style.display = "";
  ticketFilterUI('closed');
}

/* =================== FILTERS / TABLE =================== */
function ticketFilterUI(status) {
  const users = getUsers();
  const ctrl = `
    <input type="text" class="form-control search-box d-inline" id="filter-search" placeholder="Keyword">
    <select id="filter-assignee" class="form-select search-box">
      <option value="">All Users</option>
      ${users.map(u=>`<option value="${u.username.toLowerCase()}">${u.name}</option>`).join('')}
    </select>
    <select id="filter-priority" class="form-select search-box">
      <option value="">All Priority</option><option>Low</option><option>Medium</option><option>High</option><option>Urgent</option>
    </select>
    <input type="date" id="filter-date" class="form-control search-box">
    <span class="chip" id="chip-hasimg" onclick="toggleChip(this)">Has Images</span>
    <button class="btn btn-outline" onclick="filterTickets('${status}')">Filter</button>`;
  document.getElementById('ticket-list-controls').innerHTML = ctrl;
  document.getElementById('filter-search').onkeydown = function(e){ if(e.key=="Enter")filterTickets(status); };
  filterTickets(status);
}
function toggleChip(el){ el.classList.toggle('active'); }
async function filterTickets(status) {
  let tickets = (await loadAllTickets()).filter(t=>t.status===status);
  const search = (document.getElementById('filter-search')||{}).value||"";
  const assignee = (document.getElementById('filter-assignee')||{}).value||"";
  const priority = (document.getElementById('filter-priority')||{}).value||"";
  const date = (document.getElementById('filter-date')||{}).value||"";
  const hasImg = document.getElementById('chip-hasimg')?.classList.contains('active');

  tickets = tickets.filter(t=>
    (!search || JSON.stringify(t).toLowerCase().includes(search.toLowerCase())) &&
    (!assignee || (Array.isArray(t.assignedTo) && t.assignedTo.map(x=>x.toLowerCase()).includes(assignee.toLowerCase()))) &&
    (!priority || t.priority===priority) &&
    (!date || (t.createdDate||"").startsWith(date)) &&
    (!hasImg || (t.files?.length || 0) > 0)
  );

  renderTicketTable(tickets,status==="closed");
}
function renderTicketTable(tickets,isClosed) {
  if(!tickets.length) {
    document.getElementById('ticket-list-table').innerHTML = "<i>No tickets found.</i>"; return;
  }
  const group = {};
  tickets.forEach(t=>{ if(!group[t.dairyNumber]) group[t.dairyNumber]=[]; group[t.dairyNumber].push(t); });

  let html = `<table class="table table-bordered table-sm"><thead><tr>
    <th>Dairy #</th><th>Farm</th><th>Alert Type</th><th>Priority</th><th>Assigned</th><th>Opened By</th><th>Date</th><th>Status</th><th></th>
    </tr></thead><tbody>`;

  for (let dairyNum in group) {
    group[dairyNum].forEach(t=>{
      const daysOpen = t.status==="open" ? Math.max(0, Math.ceil((Date.now()-Date.parse(t.createdDate||new Date()))/86400000)) : 0;
      const aging = t.status==="open" && daysOpen>0 ? ` <span class="badge bg-warning text-dark">${daysOpen}d</span>` : '';
      html += `<tr>
        <td><span class="ticket-link" onclick="viewTicketDetails('${t.id}','${isClosed}')">${t.dairyNumber}</span></td>
        <td>${t.farmName}</td>
        <td>${t.alertType}${t.alertType==='Other'?": "+(t.alertOther||""):""}</td>
        <td>${t.priority}</td>
        <td>${(t.assignedNames||[]).join(', ')}</td>
        <td>${t.openedBy}</td>
        <td>${t.createdDate||""}${aging}</td>
        <td><span class="ticket-status-${t.status}">${t.status[0].toUpperCase()+t.status.slice(1)}</span></td>
        <td>${!isClosed && curUser.role==="admin" ? `<button class="btn btn-sm btn-agora" onclick="showCloseModal('${t.id}')">Close</button>` : ""}</td>
      </tr>`;
    });
  }
  html += "</tbody></table>";
  document.getElementById('ticket-list-table').innerHTML = html;
}

/* =================== VIEW / COMMENT / ASSIGN =================== */
window.viewTicketDetails = async function(id,isClosed) {
  let tickets = await loadAllTickets();
  let t = tickets.find(t=>t.id===id);
  if(!t) return;

  let html = `<h5>Ticket for #${t.dairyNumber}</h5>
    <b>Farm Name:</b> ${t.farmName}<br>
    <b>Alert Type:</b> ${t.alertType}${t.alertType==='Other'?": "+(t.alertOther||""):""}<br>
    <b>Priority:</b> ${t.priority}<br>
    <b>Assigned To:</b> ${(t.assignedNames||[]).join(', ')}<br>`;

  // Admin reassign (multi)
  if (curUser.role==="admin" && t.status==="open") {
    const users = getUsers();
    html += `<div class="mt-2">
      <label class="form-label">Edit Assignees</label>
      <select id="edit-assignees" class="form-select" multiple>
        ${users.map(u=>`<option value="${u.username.toLowerCase()}" ${t.assignedTo?.includes(u.username.toLowerCase())?'selected':''}>${u.name}</option>`).join('')}
      </select>
      <button class="btn btn-admin mt-1" onclick="saveAssignees('${t.id}')">Save Assignees</button>
    </div>`;
  }

  html += `<b>Status:</b> <span class="ticket-status-${t.status}">${t.status[0].toUpperCase()+t.status.slice(1)}</span><br>
    <b>Issue:</b> ${t.issueDesc}<br>
    <b>Opened by:</b> ${t.openedBy} (${t.position})<br>
    <b>Date Opened:</b> ${t.createdDate||""}<br>
    <b>Ticket ID:</b> ${t.id}<br>`;

  // Attached files/photos
  if(t.files && t.files.length){
    html += `<div class="mt-2"><b>Files:</b> `;
    t.files.forEach(f=>{
      if(f.type && f.type.startsWith('image/')) html += `<a href="${f.url}" target="_blank"><img src="${f.url}" class="photo-thumb"></a> `;
      else html += `<a class="file-chip" href="${f.url}" target="_blank">${f.name}</a> `;
    });
    html += `</div>`;
  }

  // Comments thread
  html += `<div class="mt-3"><b>Comments:</b><br>`;
  (t.comments||[]).forEach(c=>{
    html += `<div class="comment-box">
      <div class="comment-meta">${c.user} @ ${c.date}</div>
      <div>${c.text||''}</div>
      ${(c.files&&c.files.length)?`<div class="mt-1">`+
        c.files.map(ff=>ff.type?.startsWith('image/')?`<a href="${ff.url}" target="_blank"><img src="${ff.url}" class="photo-thumb"></a>`:`<a class="file-chip" href="${ff.url}" target="_blank">${ff.name}</a>`).join(' ')
      +`</div>`:''}
    </div>`;
  });
  html += `</div>`;

  // Add comment (with files)
  if(t.status==="open"){
    html += `<div class="mt-2">
      <textarea id="new-comment" class="form-control" rows="2" placeholder="Add internal note..."></textarea>
      <input type="file" id="comment-files" class="form-control mt-1" multiple accept="image/*,.pdf,.doc,.docx,.txt" capture="environment">
      <div id="comment-files-preview" class="mt-1"></div>
      <button class="btn btn-agora mt-1" onclick="addComment('${t.id}')">Add Comment</button>
    </div>`;
    setTimeout(()=>{
      const inp = document.getElementById('comment-files');
      const pv = document.getElementById('comment-files-preview');
      inp?.addEventListener('change',()=>renderFilePreview(inp.files,pv));
    },0);
  }

  // Ticket history & close info
  html += `<div class="mt-3"><b>Ticket History:</b><br>`;
  (t.history||[]).forEach(h=>{
    html += `<div class="history-box">${h.action} by ${h.user} @ ${h.date}${h.details?": "+h.details:""}</div>`;
  });
  html += `</div>`;

  if(t.status==="closed" && t.close){
    html+=`<b>Closed by:</b> ${t.close.by}<br><b>Date Closed:</b> ${t.close.date||""}<br><b>Resolution:</b> ${t.close.note||""}<br>`;
    if (t.close.files?.length){
      html += `<div class="mt-1"><b>Resolution Files:</b> `+
      t.close.files.map(ff=>ff.type?.startsWith('image/')?`<a href="${ff.url}" target="_blank"><img src="${ff.url}" class="photo-thumb"></a>`:`<a class="file-chip" href="${ff.url}" target="_blank">${ff.name}</a>`).join(' ')
      +`</div>`;
    }
  }

  document.getElementById('ticket-view-modal').innerHTML = html;
  document.getElementById('ticket-view-modal').style.display="";
};

window.addComment = async function(id) {
  let commentText = document.getElementById('new-comment').value.trim();
  const files = Array.from((document.getElementById('comment-files')||{files:[]}).files);
  if(!commentText && files.length===0) return;

  const errs = validateFiles(files);
  if (errs.length) return alert("Upload errors:\n" + errs.join("\n"));

  let tickets = await loadAllTickets();
  let t = tickets.find(t=>t.id===id);
  if(!t) return;

  const c = { id: uuidv4(), text: commentText, user: curUser.name, date: (new Date()).toLocaleString(), files: [] };

  // progress renders
  const pv = document.getElementById('comment-files-preview');
  files.forEach(()=>{ const bar=document.createElement('div'); bar.className='progress-mini'; bar.innerHTML='<div></div>'; pv.appendChild(bar); });

  for (let i=0;i<files.length;i++){
    const f = files[i];
    const barFill = pv.querySelectorAll('.progress-mini > div')[i];
    const url = await uploadFileBlob(f, `comments/${id}_${c.id}`, barFill);
    c.files.push({ name: f.name, type: f.type, url });
  }

  t.comments = t.comments||[];
  t.comments.push(c);
  t.history = t.history||[];
  const fileNames = c.files.map(f=>f.name).join(', ');
  t.history.push({action:"CommentWithFiles", user:curUser.name, date:(new Date()).toISOString(), details: (commentText||'') + (fileNames?` [${fileNames}]`:'') });

  await storage.ref(`${ticketsFolder}/${t.id}.json`).put(new Blob([JSON.stringify(t)],{type:"application/json"}));
  viewTicketDetails(id, t.status==="closed");
};

window.saveAssignees = async function(id){
  if(curUser.role!=="admin") return;
  const sel = document.getElementById('edit-assignees');
  const newUsernames = Array.from(sel.selectedOptions).map(o=>o.value.toLowerCase());
  const users = getUsers();
  const newNames = newUsernames.map(u=>(users.find(x=>x.username===u)||{}).name||u);

  let tickets = await loadAllTickets();
  let t = tickets.find(t=>t.id===id);
  if(!t) return;

  const old = (t.assignedNames||[]).join(', ');
  t.assignedTo = newUsernames;
  t.assignedNames = newNames;
  t.history = t.history||[];
  t.history.push({action:"Reassigned", user:curUser.name, date:(new Date()).toISOString(), details:`${old} → ${newNames.join(', ')}`});

  await storage.ref(`${ticketsFolder}/${t.id}.json`).put(new Blob([JSON.stringify(t)],{type:"application/json"}));

  // notify each new assignee
  for (const uname of newUsernames) {
    const toUser = users.find(u=>u.username===uname);
    if (toUser) sendTicketEmailNotification(t, toUser.username);
  }
  viewTicketDetails(id,false);
};

/* =================== CLOSE TICKET (MODAL) =================== */
function showCloseModal(id){ closeTicketId = id; document.getElementById('close-note').value=''; document.getElementById('close-files').value=''; document.getElementById('close-files-preview').innerHTML=''; document.getElementById('close-modal').style.display='flex'; }
function hideCloseModal(){ document.getElementById('close-modal').style.display='none'; closeTicketId=null; }
document.getElementById('close-files').addEventListener('change', function(){
  renderFilePreview(this.files, document.getElementById('close-files-preview'));
});
async function doCloseFromModal(){
  if(!closeTicketId) return;
  const note = document.getElementById('close-note').value.trim();
  const files = Array.from((document.getElementById('close-files')||{files:[]}).files);
  const errs = validateFiles(files);
  if (errs.length) return alert("Upload errors:\n" + errs.join("\n"));

  let tickets = await loadAllTickets();
  let t = tickets.find(t=>t.id===closeTicketId);
  if(!t) return;

  const close = { note, by: curUser.name, date: (new Date()).toISOString().substr(0,10), files: [] };

  const pv = document.getElementById('close-files-preview');
  files.forEach(()=>{ const bar=document.createElement('div'); bar.className='progress-mini'; bar.innerHTML='<div></div>'; pv.appendChild(bar); });

  for (let i=0;i<files.length;i++){
    const f = files[i];
    const barFill = pv.querySelectorAll('.progress-mini > div')[i];
    const url = await uploadFileBlob(f, `close/${t.id}`, barFill);
    close.files.push({ name: f.name, type: f.type, url });
  }

  t.status = "closed";
  t.close = close;
  t.history = t.history||[];
  const fNames = close.files.map(ff=>ff.name).join(', ');
  t.history.push({action:"ClosedWithFiles", user:curUser.name, date:(new Date()).toISOString(), details:(note||'') + (fNames?` [${fNames}]`:'')});

  await storage.ref(`${ticketsFolder}/${t.id}.json`).put(new Blob([JSON.stringify(t)],{type:"application/json"}));

  hideCloseModal();
  alert("Ticket closed.");
  showOpenTickets();
}

/* =================== SUMMARY / CSV =================== */
async function showSummary() {
  if(curUser.role!=="admin") return alert("Admins only.");
  document.getElementById('ticket-section').style.display="none";
  document.getElementById('ticket-list-section').style.display="";
  document.getElementById('btn-csv').style.display = "";
  let tickets = await loadAllTickets();

  let group = {}; tickets.forEach(t=>{if(!group[t.dairyNumber])group[t.dairyNumber]=[];group[t.dairyNumber].push(t);});
  let sorted = Object.keys(group).sort((a,b)=>group[b].length-group[a].length);
  let alertCounts = {};
  tickets.forEach(t=>{let type=t.alertType||"Unknown";alertCounts[type]=(alertCounts[type]||0)+1;});
  document.getElementById('ticket-list-controls').innerHTML =
    `<div class="mb-2"><b>Alert Type Breakdown:</b> ${Object.keys(alertCounts).map(k=>`${k}: <b>${alertCounts[k]}</b>`).join(" &nbsp; ")}</div>
     <input type="text" class="form-control search-box d-inline" id="search-sum" placeholder="Search Dairy #">`;
  document.getElementById('search-sum').oninput = function() {
    let v=this.value.toLowerCase();
    renderSummary(sorted.filter(dn=>dn.toLowerCase().includes(v)), group);
  };
  renderSummary(sorted, group);
}
function renderSummary(sorted, group) {
  let html = `<table class="table table-bordered table-sm"><thead><tr>
    <th>Dairy #</th><th>Num Tickets</th></tr></thead><tbody>`;
  sorted.forEach(dn=>{
    html += `<tr>
      <td><span class="ticket-link" onclick="expandDairy('${dn}')">${dn}</span></td>
      <td>${group[dn].length}</td>
      </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById('ticket-list-table').innerHTML = html;
  document.getElementById('ticket-view-modal').innerHTML = '';
  document.getElementById('ticket-view-modal').style.display = "none";
}
window.expandDairy = function(dn) { expandDairyTickets(dn); };
async function expandDairyTickets(dn) {
  let tickets = await loadAllTickets();
  let arr = tickets.filter(t=>t.dairyNumber===dn);
  arr.sort((a,b)=>(b.createdDate||"").localeCompare((a.createdDate||"")));
  let html = `<h5>Tickets for Dairy #${dn}</h5><ul>`;
  arr.forEach(t=>{
    html += `<li>
      <span class="ticket-link" onclick="viewTicketDetails('${t.id}',${t.status==="closed"})">${t.status==='closed'?'(Closed)':''} ${t.createdDate||""}
        - ${t.alertType}${t.alertType==='Other'?": "+(t.alertOther||""):""}
      </span>
    </li>`;
  });
  html += "</ul>";
  document.getElementById('ticket-view-modal').innerHTML = html;
  document.getElementById('ticket-view-modal').style.display = "";
}
async function exportToCSV() {
  let tickets = await loadAllTickets();
  let header = [
    "ID","DairyNumber","FarmName","AlertType","Priority",
    "AssignedTo","Status","CreatedDate","ClosedDate","OpenedBy","ClosedBy",
    "IssueDescription","CloseDescription","IssueFiles","CommentFilesCount","ResolvedFiles","CommentsCount","HistoryCount"
  ];
  let rows = [header.join(",")];

  function quote(x){ return '"'+String(x||"").replace(/"/g,'""')+'"'; }

  tickets.forEach(t=>{
    const issueFiles = (t.files||[]).map(f=>f.url).join(" ; ");
    const commentFilesCount = (t.comments||[]).reduce((a,c)=>a+(c.files?.length||0),0);
    const resolvedFiles = (t.close?.files||[]).map(f=>f.url).join(" ; ");
    const assigned = (t.assignedNames||[]).join("; ");

    const row = [
      t.id, t.dairyNumber, t.farmName, t.alertType, t.priority,
      assigned, t.status, t.createdDate, (t.close?.date||""), t.openedBy, (t.close?.by||""),
      t.issueDesc||"", (t.close?.note||""), issueFiles, commentFilesCount, resolvedFiles, (t.comments||[]).length, (t.history||[]).length
    ];
    rows.push(row.map(quote).join(","));
  });
  const csv = rows.join("\r\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "tickets_export.csv";
  document.body.appendChild(a);
  a.click(); setTimeout(()=>{a.remove();URL.revokeObjectURL(url);},1000);
}

/* =================== ADMIN PANEL =================== */
function adminPanel() {
  if(curUser.role!=="admin") return alert("Admins only.");
  let html = `<h5>Admin: User Permissions</h5>
    <div class="mb-2">Promote users to Admin by username:</div>
    <input type="text" class="form-control search-box d-inline" id="promote-user" placeholder="Username">
    <button class="btn btn-admin mt-2 ms-2" onclick="promoteUser()">Promote to Admin</button>
    <div class="mt-2" id="promote-msg"></div>`;
  document.getElementById('ticket-list-controls').innerHTML = html;
  document.getElementById('ticket-list-table').innerHTML = "";
  document.getElementById('ticket-view-modal').innerHTML = '';
  document.getElementById('ticket-view-modal').style.display = "none";
}
function promoteUser() {
  let username = document.getElementById('promote-user').value.trim().toLowerCase();
  let users = getUsers();
  let user = users.find(u=>u.username.toLowerCase() === username);
  if(!user) return document.getElementById('promote-msg').textContent = "User not found.";
  user.role = "admin"; setUsers(users);
  document.getElementById('promote-msg').textContent = "Promoted to admin.";
}

/* =================== EMAIL =================== */
function sendTicketEmailNotification(ticket, toEmail) {
  const users = getUsers();
  const openedUser = users.find(u=>u.username.toLowerCase() === (ticket.openedByUser||"").toLowerCase());
  const email_to = toEmail || "";
  const email_cc = openedUser ? openedUser.username : "";

  if(!email_to){
    alert("Error sending ticket email: no recipient.");
    return;
  }
  const ticketLink = TICKET_URL_ROOT + "#ticket=" + ticket.id;
  const emailVars = {
    ticket_id: ticket.id,
    dairy_number: ticket.dairyNumber,
    farm_name: ticket.farmName,
    alert_type: ticket.alertType === "Other" ? (ticket.alertType + ": " + (ticket.alertOther||"")) : ticket.alertType,
    priority: ticket.priority,
    assigned_to: (ticket.assignedNames||[]).join(', '),
    opened_by: ticket.openedBy,
    created_date: ticket.createdDate,
    issue_desc: ticket.issueDesc,
    ticket_link: ticketLink,
    to_email: email_to,
    cc_email: email_cc
  };

  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailVars, EMAILJS_PUBLIC_KEY)
    .then(()=>{}, (error)=>{ console.error("EmailJS send error", error); });
}

/* =================== DEEP LINK =================== */
window.addEventListener("hashchange", checkHashForTicket);
function checkHashForTicket() {
  let hash = location.hash||"";
  if(hash.startsWith("#ticket=")) {
    let ticketId = hash.replace("#ticket=","");
    if(document.getElementById('ticket-section').style.display==="none")
      showMain();
    setTimeout(()=>{viewTicketDetails(ticketId,false);}, 100);
  }
}
</script>
</body>
</html>