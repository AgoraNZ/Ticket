<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Ticketing System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <!-- Custom styles and settings -->
  <style>
    /* === CONFIGURABLE SETTINGS === */
    :root {
      --main-bg: #f8faff;
      --primary: #001F3F;
      --accent: #FF851B;
      --danger: #FF4136;
      --success: #2ECC40;
      --font-main: 'Segoe UI', Arial, sans-serif;
      --logo-width: 220px;
      --input-radius: 7px;
      --btn-radius: 5px;
      --max-width: 950px;
      --text-size: 1rem;
      --heading-size: 2rem;
      --label-size: 1.05rem;
    }
    html, body { background: var(--main-bg); color: var(--primary); font-family: var(--font-main); font-size: var(--text-size);}
    .container-main { background: #fff; border-radius: 18px; max-width: var(--max-width); margin: 30px auto 0 auto; padding: 32px 24px 34px 24px; box-shadow: 0 2px 32px #001F3F12; }
    .logo-header { max-width: var(--logo-width); display:block; margin:0 auto 18px auto; }
    h1,h2 { color: var(--accent); font-size: var(--heading-size); text-align: center; }
    .form-label { color: var(--primary); font-size: var(--label-size); font-weight:500; }
    .form-control, .form-select { border-radius: var(--input-radius); }
    .btn-agora { background: var(--accent); color:#fff; border:none; border-radius:var(--btn-radius); font-weight:500; }
    .btn-agora:hover { background: var(--danger); color:#fff; }
    .btn-admin { background: var(--primary); color: #fff; border:none; border-radius:var(--btn-radius);}
    .btn-admin:hover { background: #193a5e; }
    .btn-outline { background: #fff; color: var(--primary); border:1px solid var(--accent);}
    .btn-outline:hover { background: var(--accent); color:#fff;}
    .ticket-status-open { color: var(--success); font-weight:600;}
    .ticket-status-closed { color: var(--danger);}
    .hidden { display: none; }
    .nav-btns { display:flex; gap:13px; justify-content:center; margin:16px 0 4px 0;}
    .ticket-link { cursor:pointer; text-decoration:underline; color:var(--primary);}
    .ticket-link:hover { color: var(--accent);}
    .search-box { max-width: 260px; margin: 0 0 10px 0; }
    .alert-summary-box { background:#f1f4f9; border-radius:7px; padding:11px 18px; margin-bottom:18px;}
    .summary-list { font-size:1.13em; margin-top:4px; }
    .table-smaller td, .table-smaller th { font-size:0.97em; padding:6px;}
    .logout-link { float:right; color:#a00; text-decoration:underline; cursor:pointer; font-size:0.96em;}
    .input-smaller { font-size: 0.97em; }
    .mt-04 { margin-top: 0.5rem;}
    .mt-2x { margin-top: 2.2rem;}
    @media (max-width:600px) {
      .container-main { padding: 9px 2vw; }
      h1,h2 { font-size:1.5rem;}
      .logo-header { max-width: 120px;}
    }
  </style>
</head>
<body>
<div class="container-main" id="main-box">
  <img id="logo-img" class="logo-header" style="display:none;">
  <h1>Agora Dairy Service Ticketing</h1>

  <!-- LOGIN/SIGNUP SECTION -->
  <div id="login-section">
    <div id="login-box" class="mb-3">
      <label class="form-label">Email</label>
      <input type="email" id="login-email" class="form-control" autocomplete="username" required>
      <label class="form-label mt-04">Password</label>
      <input type="password" id="login-pass" class="form-control" autocomplete="current-password" required>
      <button class="btn btn-agora mt-3 w-100" onclick="doLogin()">Login</button>
      <div class="mt-2 text-center">
        <span style="font-size:0.98em;">No account? <a href="#" onclick="showSignup()">Sign Up</a></span>
      </div>
    </div>
    <div id="signup-box" class="mb-3 hidden">
      <label class="form-label">Full Name</label>
      <input type="text" id="signup-name" class="form-control" required>
      <label class="form-label mt-04">Email</label>
      <input type="email" id="signup-email" class="form-control" required>
      <label class="form-label mt-04">Password</label>
      <input type="password" id="signup-pass" class="form-control" required>
      <button class="btn btn-agora mt-3 w-100" onclick="doSignup()">Sign Up</button>
      <div class="mt-2 text-center">
        <span style="font-size:0.98em;">Have an account? <a href="#" onclick="showLogin()">Login</a></span>
      </div>
    </div>
    <div id="login-msg" class="text-danger mt-2" style="min-height:20px;"></div>
  </div>

  <!-- MAIN TICKET PAGE -->
  <div id="ticket-section" class="hidden">
    <span class="logout-link" onclick="logout()">Logout</span>
    <div class="mb-2 text-center"><b id="user-position"></b></div>
    <form id="ticket-form" autocomplete="off">
      <div class="mb-3">
        <label class="form-label">Service Person</label>
        <input type="text" id="service-person" class="form-control input-smaller" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">Date</label>
        <input type="date" id="ticket-date" class="form-control input-smaller" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Dairy Number</label>
        <input type="text" id="dairy-number" class="form-control input-smaller" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Farm Name</label>
        <input type="text" id="farm-name" class="form-control input-smaller" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Alert Type</label>
        <select id="alert-type" class="form-select input-smaller" onchange="toggleOtherAlert()">
          <option value="">Select...</option>
          <option value="Temperature">Temperature</option>
          <option value="Concentration">Concentration</option>
          <option value="Plant Pressure">Plant Pressure</option>
          <option value="Milking Vacuum">Milking Vacuum</option>
          <option value="Teat Spray">Teat Spray</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-3 hidden" id="other-alert-div">
        <label class="form-label">Other Alert Type</label>
        <input type="text" id="alert-other" class="form-control input-smaller">
      </div>
      <div class="mb-3">
        <label class="form-label">Description of Issue</label>
        <textarea id="issue-desc" class="form-control" rows="2" required></textarea>
      </div>
      <button type="button" class="btn btn-agora mt-2" onclick="submitTicket()">Create Ticket</button>
    </form>
    <div class="nav-btns mt-2x">
      <button class="btn btn-outline" id="btn-open-tickets" onclick="showOpenTickets()">Open Tickets <span id="num-open-tix" class="badge bg-success"></span></button>
      <button class="btn btn-outline" id="btn-closed-tickets" onclick="showClosedTickets()">Closed Tickets</button>
      <button class="btn btn-admin" id="btn-summary" onclick="showSummary()">Summary</button>
      <button class="btn btn-admin ms-3" id="btn-admin" onclick="adminPanel()">Admin Panel</button>
    </div>
    <div id="ticket-msg" class="mt-2" style="min-height:22px;"></div>
  </div>

  <!-- TICKET VIEWS (open/closed/summary) -->
  <div id="ticket-list-section" class="hidden">
    <div class="mb-2">
      <button class="btn btn-outline" onclick="backToMain()">Back</button>
    </div>
    <div id="ticket-list-controls" class="mb-3"></div>
    <div id="ticket-list-table"></div>
    <div id="ticket-view-modal" class="hidden mt-3"></div>
  </div>
</div>

<!-- Firebase and dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
<script>
/* === CONFIGURE THIS SECTION === */
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
const bucketPath = "Agora V1 Tickets"; // All tickets stored here

// ============ APP STARTUP ==============
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const usersRef = db.collection("users");
const ticketsRef = db.collection("tickets");

let user = null, userProfile = null, isAdmin = false;

// === Load Logo ===
(async function(){
  try {
    const logoRef = storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
    const logoUrl = await logoRef.getDownloadURL();
    document.getElementById("logo-img").src = logoUrl;
    document.getElementById("logo-img").style.display = "block";
  } catch {}
})();

function showLogin() {
  document.getElementById('login-box').classList.remove('hidden');
  document.getElementById('signup-box').classList.add('hidden');
  document.getElementById('login-msg').textContent = '';
}
function showSignup() {
  document.getElementById('login-box').classList.add('hidden');
  document.getElementById('signup-box').classList.remove('hidden');
  document.getElementById('login-msg').textContent = '';
}
function showMain() {
  document.getElementById('login-section').classList.add('hidden');
  document.getElementById('ticket-section').classList.remove('hidden');
  document.getElementById('ticket-list-section').classList.add('hidden');
  setTimeout(() => document.getElementById('ticket-msg').textContent = '', 1500);
}
function showTicketList() {
  document.getElementById('ticket-section').classList.add('hidden');
  document.getElementById('ticket-list-section').classList.remove('hidden');
}

// ==== LOGIN/SIGNUP LOGIC ====
async function doLogin() {
  let email = document.getElementById('login-email').value.trim();
  let pass = document.getElementById('login-pass').value;
  try {
    let res = await auth.signInWithEmailAndPassword(email, pass);
    user = res.user;
    await loadProfile();
    showMain();
    autoFillTicketForm();
  } catch(e) {
    document.getElementById('login-msg').textContent = "Login failed: " + (e.message||"Check details");
  }
}
async function doSignup() {
  let name = document.getElementById('signup-name').value.trim();
  let email = document.getElementById('signup-email').value.trim();
  let pass = document.getElementById('signup-pass').value;
  if (!name || !email || !pass) { document.getElementById('login-msg').textContent = "All fields required."; return;}
  try {
    let res = await auth.createUserWithEmailAndPassword(email, pass);
    await usersRef.doc(res.user.uid).set({
      name, email, position: "service", created: new Date(), admin: false
    });
    user = res.user;
    await loadProfile();
    showMain();
    autoFillTicketForm();
  } catch(e) {
    document.getElementById('login-msg').textContent = "Sign up failed: " + (e.message||"");
  }
}
async function loadProfile() {
  if (!auth.currentUser) return;
  let doc = await usersRef.doc(auth.currentUser.uid).get();
  userProfile = doc.exists ? doc.data() : {};
  isAdmin = !!(userProfile.admin || userProfile.position === 'admin');
  document.getElementById('user-position').textContent =
    `Position: Agora Service | ${userProfile.name||"??"}${isAdmin ? " (Admin)" : ""}`;
}
async function logout() {
  await auth.signOut();
  location.reload();
}
auth.onAuthStateChanged(async (u) => {
  if (u) { user = u; await loadProfile(); showMain(); autoFillTicketForm(); loadOpenTicketCount(); }
  else { user = null; userProfile = null; isAdmin = false; showLogin(); }
});

// =========== TICKET FORM LOGIC ============
function autoFillTicketForm() {
  document.getElementById('service-person').value = userProfile ? userProfile.name : "";
  document.getElementById('ticket-date').value = (new Date()).toISOString().substr(0,10);
}
function toggleOtherAlert() {
  let v = document.getElementById('alert-type').value;
  document.getElementById('other-alert-div').classList.toggle('hidden', v !== 'Other');
}
async function submitTicket() {
  let data = {
    id: uuidv4(), // unique ID
    created: firebase.firestore.FieldValue.serverTimestamp(),
    createdDate: document.getElementById('ticket-date').value,
    dairyNumber: document.getElementById('dairy-number').value.trim(),
    farmName: document.getElementById('farm-name').value.trim(),
    alertType: document.getElementById('alert-type').value,
    alertOther: document.getElementById('alert-other').value.trim(),
    issueDesc: document.getElementById('issue-desc').value.trim(),
    status: "open",
    openedBy: userProfile ? userProfile.name : "",
    position: "Agora Service",
    openedUid: user ? user.uid : "",
    closedBy: "", closedUid: "", closeComment: "", closedDate: null
  };
  if (!data.dairyNumber || !data.farmName || !data.alertType || !data.issueDesc)
    return (document.getElementById('ticket-msg').textContent = "All required fields must be filled out.");
  if (data.alertType === 'Other' && !data.alertOther)
    return (document.getElementById('ticket-msg').textContent = "Specify the 'Other' alert type.");
  await ticketsRef.doc(data.id).set(data);
  document.getElementById('ticket-msg').textContent = "Ticket created.";
  document.getElementById('ticket-form').reset();
  autoFillTicketForm();
  loadOpenTicketCount();
}
async function loadOpenTicketCount() {
  let qs = await ticketsRef.where("status","==","open").get();
  document.getElementById("num-open-tix").textContent = qs.size;
}

// =========== NAV BUTTONS ==============
function backToMain() {
  showMain();
  document.getElementById('ticket-list-table').innerHTML = "";
  document.getElementById('ticket-list-controls').innerHTML = "";
  document.getElementById('ticket-view-modal').classList.add('hidden');
}
// --- Only admin can see Closed, Summary, Admin Panel ---
document.getElementById('btn-closed-tickets').style.display = "none";
document.getElementById('btn-summary').style.display = "none";
document.getElementById('btn-admin').style.display = "none";
setInterval(() => {
  if (isAdmin) {
    document.getElementById('btn-closed-tickets').style.display = "";
    document.getElementById('btn-summary').style.display = "";
    document.getElementById('btn-admin').style.display = "";
  }
}, 2000);

// =========== OPEN/CLOSED TICKETS =============
async function showOpenTickets() {
  showTicketList();
  document.getElementById('ticket-list-controls').innerHTML =
    '<b>Open Tickets</b>';
  let qs = await ticketsRef.where("status","==","open").get();
  let arr = qs.docs.map(doc => doc.data());
  renderTicketTable(arr, false);
}
async function showClosedTickets() {
  if (!isAdmin) return alert("Admins only.");
  showTicketList();
  document.getElementById('ticket-list-controls').innerHTML =
    `<input type="text" class="form-control search-box d-inline" id="search-closed" placeholder="Search Dairy #">
     <b>Closed Tickets</b>`;
  document.getElementById('search-closed').oninput = async function() {
    let search = this.value.toLowerCase();
    let qs = await ticketsRef.where("status","==","closed").get();
    let arr = qs.docs.map(d=>d.data()).filter(t=>t.dairyNumber.toLowerCase().includes(search));
    renderTicketTable(arr, true);
  };
  let qs = await ticketsRef.where("status","==","closed").get();
  renderTicketTable(qs.docs.map(d=>d.data()), true);
}

function renderTicketTable(tickets, isClosed) {
  if (!tickets.length) {
    document.getElementById('ticket-list-table').innerHTML = "<i>No tickets found.</i>";
    return;
  }
  let group = {};
  tickets.forEach(t => {
    if (!group[t.dairyNumber]) group[t.dairyNumber] = [];
    group[t.dairyNumber].push(t);
  });
  let html = `<table class="table table-bordered table-smaller"><thead><tr>
    <th>Dairy #</th><th>Farm</th><th>Alert Type</th><th>Opened By</th><th>Date</th><th>Status</th><th></th>
    </tr></thead><tbody>`;
  for (let dairyNum in group) {
    group[dairyNum].forEach(t => {
      html += `<tr>
        <td><span class="ticket-link" onclick="viewTicketDetails('${t.id}','${isClosed}')">${t.dairyNumber}</span></td>
        <td>${t.farmName}</td>
        <td>${t.alertType}${t.alertType==='Other' ? ": "+(t.alertOther||"") : ""}</td>
        <td>${t.openedBy}</td>
        <td>${t.createdDate||""}</td>
        <td><span class="ticket-status-${t.status}">${t.status[0].toUpperCase()+t.status.slice(1)}</span></td>
        <td>${!isClosed && (isAdmin||t.openedUid===user.uid) ? `<button class="btn btn-sm btn-agora" onclick="closeTicketPrompt('${t.id}')">Close</button>` : ""}</td>
        </tr>`;
    });
  }
  html += "</tbody></table>";
  document.getElementById('ticket-list-table').innerHTML = html;
}
window.viewTicketDetails = async function(id, isClosed) {
  let doc = await ticketsRef.doc(id).get();
  if (!doc.exists) return;
  let t = doc.data();
  let html = `<h5>Ticket for #${t.dairyNumber}</h5>
    <b>Farm Name:</b> ${t.farmName}<br>
    <b>Alert Type:</b> ${t.alertType}${t.alertType==='Other'? ": "+(t.alertOther||""):""}<br>
    <b>Status:</b> <span class="ticket-status-${t.status}">${t.status[0].toUpperCase()+t.status.slice(1)}</span><br>
    <b>Issue:</b> ${t.issueDesc}<br>
    <b>Opened by:</b> ${t.openedBy} (${t.position})<br>
    <b>Date Opened:</b> ${t.createdDate||""}<br>
    <b>Ticket ID:</b> ${t.id}<br>`;
  if (t.status === "closed")
    html += `<b>Closed by:</b> ${t.closedBy}<br>
    <b>Date Closed:</b> ${t.closedDate||""}<br>
    <b>Resolution:</b> ${t.closeComment||""}<br>`;
  document.getElementById('ticket-view-modal').innerHTML = html;
  document.getElementById('ticket-view-modal').classList.remove('hidden');
};

window.closeTicketPrompt = function(id) {
  let comment = prompt("Describe the fix / action taken:");
  if (!comment) return;
  closeTicket(id, comment);
};
async function closeTicket(id, closeComment) {
  let doc = await ticketsRef.doc(id).get();
  if (!doc.exists) return;
  let t = doc.data();
  await ticketsRef.doc(id).update({
    status: "closed",
    closeComment,
    closedBy: userProfile ? userProfile.name : "",
    closedUid: user ? user.uid : "",
    closedDate: (new Date()).toISOString().substr(0,10)
  });
  alert("Ticket closed.");
  showOpenTickets();
}

// ============== SUMMARY ===============
async function showSummary() {
  if (!isAdmin) return alert("Admins only.");
  showTicketList();
  let tickets = (await ticketsRef.get()).docs.map(d=>d.data());
  // Dairy number with most tickets first
  let group = {};
  tickets.forEach(t=>{
    if (!group[t.dairyNumber]) group[t.dairyNumber]=[];
    group[t.dairyNumber].push(t);
  });
  let sorted = Object.keys(group).sort((a,b)=>group[b].length-group[a].length);
  // Alert type counts
  let alertCounts = {};
  tickets.forEach(t=>{
    let type = t.alertType || "Unknown";
    alertCounts[type] = (alertCounts[type]||0)+1;
  });
  // Controls
  document.getElementById('ticket-list-controls').innerHTML =
    `<div class="alert-summary-box">
      <b>Alert Type Breakdown:</b>
      <div class="summary-list">
      ${Object.keys(alertCounts).map(k=>`${k}: <b>${alertCounts[k]}</b>`).join(" &nbsp; ")}
      </div>
     </div>
     <input type="text" class="form-control search-box d-inline" id="search-sum" placeholder="Search Dairy #">`;
  document.getElementById('search-sum').oninput = function() {
    let v = this.value.toLowerCase();
    renderSummary(sorted.filter(dn=>dn.toLowerCase().includes(v)), group);
  };
  renderSummary(sorted, group);
}
function renderSummary(sorted, group) {
  let html = `<table class="table table-bordered table-smaller"><thead><tr>
    <th>Dairy #</th><th>Num Tickets</th><th></th></tr></thead><tbody>`;
  sorted.forEach(dn=>{
    html += `<tr>
      <td><span class="ticket-link" onclick="expandDairy('${dn}')">${dn}</span></td>
      <td>${group[dn].length}</td>
      <td></td>
      </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById('ticket-list-table').innerHTML = html;
  document.getElementById('ticket-view-modal').innerHTML = '';
  document.getElementById('ticket-view-modal').classList.add('hidden');
}
window.expandDairy = function(dn) {
  expandDairyTickets(dn);
};
async function expandDairyTickets(dn) {
  let qs = await ticketsRef.where("dairyNumber","==",dn).get();
  let arr = qs.docs.map(d=>d.data());
  arr.sort((a,b)=>(b.created||"").toString().localeCompare((a.created||"").toString()));
  let html = `<h5>Tickets for Dairy #${dn}</h5><ul>`;
  arr.forEach(t=>{
    html += `<li>
      <span class="ticket-link" onclick="viewTicketDetails('${t.id}',${t.status==="closed"})">${t.status==='closed'?'(Closed)':''} ${t.createdDate||""}
        - ${t.alertType}${t.alertType==='Other'? ": "+(t.alertOther||""):""}
      </span>
    </li>`;
  });
  html += "</ul>";
  document.getElementById('ticket-view-modal').innerHTML = html;
  document.getElementById('ticket-view-modal').classList.remove('hidden');
}

// ========== ADMIN PANEL ===============
function adminPanel() {
  if (!isAdmin) return alert("Admins only.");
  let html = `<h5>Admin: User Permissions</h5>
    <div class="mb-2">Promote users to Admin by email:</div>
    <input type="text" class="form-control search-box d-inline" id="promote-email" placeholder="User Email">
    <button class="btn btn-admin mt-2 ms-2" onclick="promoteUser()">Promote to Admin</button>
    <div class="mt-2" id="promote-msg"></div>`;
  document.getElementById('ticket-list-controls').innerHTML = html;
  document.getElementById('ticket-list-table').innerHTML = "";
  document.getElementById('ticket-view-modal').innerHTML = '';
  document.getElementById('ticket-view-modal').classList.add('hidden');
}
async function promoteUser() {
  let email = document.getElementById('promote-email').value.trim().toLowerCase();
  if (!email) return document.getElementById('promote-msg').textContent = "Enter a user email.";
  let snap = await usersRef.where("email","==",email).get();
  if (!snap.size) return document.getElementById('promote-msg').textContent = "User not found.";
  let doc = snap.docs[0];
  await usersRef.doc(doc.id).update({ admin:true, position:"admin" });
  document.getElementById('promote-msg').textContent = "Promoted to admin.";
}

</script>
</body>
</html>
